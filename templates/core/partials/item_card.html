{% load akka_filters %}
{% comment %}
Partial: Card reutilizável para exibir SvgFile (variável: item)
Usa Alpine.js para modal de preview
Botões aparecem apenas no hover
{% endcomment %}

<div class="card" id="svg-card-{{ item.pk }}" x-data="{ showModal: false, imgError: false, svgHtml: '', svgLoading: false, isHovered: false }" @mouseenter="isHovered = true" @mouseleave="isHovered = false" style="background: var(--color-gray-900); border: 1px solid var(--color-gray-800); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; position: relative;" :style="isHovered && 'border-color: var(--color-gray-700); transform: translateY(-4px)'">
  {# Preview do SVG - Aspect ratio 4:3 #}
  <div style="aspect-ratio: 4/3; background: var(--color-gray-800); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; padding: 1rem;">
    {% if item.thumbnail %}
      <img 
        src="{{ item.thumbnail.url }}" 
        alt="Preview de {{ item.title_name|default:item.filename }}"
        loading="lazy"
        x-show="!imgError"
        @error="imgError = true"
        style="width: 120px; height: 120px; object-fit: contain; transition: transform 0.3s ease;"
        :style="isHovered && 'transform: scale(1.05)'"
      >
      <div x-show="imgError" style="display:none; text-align: center; color: var(--text-muted); font-size: 0.875rem;">
        <i data-lucide="image-off" style="width: 48px; height: 48px; margin-bottom: 0.5rem; opacity: 0.5;"></i>
        <p>Sem prévia disponível</p>
      </div>
    {% elif item.content %}
      <img 
        src="data:image/svg+xml;base64,{{ item.get_sanitized_content|base64_encode }}"
        alt="Preview de {{ item.title_name|default:item.filename }}"
        loading="lazy"
        x-show="!imgError"
        @error="imgError = true"
        style="width: 120px; height: 120px; object-fit: contain; transition: transform 0.3s ease;"
        :style="isHovered && 'transform: scale(1.05)'"
      >
      <div x-show="imgError" style="display:none; text-align: center; color: var(--text-muted); font-size: 0.875rem;">
        <i data-lucide="image-off" style="width: 48px; height: 48px; margin-bottom: 0.5rem; opacity: 0.5;"></i>
        <p>Erro ao carregar</p>
      </div>
    {% else %}
      <div style="text-align: center; color: var(--text-muted); font-size: 0.875rem;">
        <i data-lucide="image-off" style="width: 48px; height: 48px; margin-bottom: 0.5rem; opacity: 0.5;"></i>
        <p>Sem prévia disponível</p>
      </div>
    {% endif %}
    
    {# Overlay com botões - Aparece no hover - BOTÕES LADO A LADO NA PARTE DE BAIXO #}
    <div x-show="isHovered" x-transition style="position: absolute; inset: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); display: flex; flex-direction: row; align-items: flex-end; justify-content: center; gap: 0.75rem; padding: 1rem;">
      {# Botão Visualizar - Apenas ícone #}
      <button 
        @click="showModal = true" 
        class="btn btn-outline"
        type="button"
        title="Visualizar"
        style="padding: 0.75rem; font-size: 0.875rem; font-weight: 600; border-radius: 8px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); color: white; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;"
        onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'; this.style.transform='scale(1.05)'"
        onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'; this.style.transform='scale(1)'"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
      </button>
      
      {% if user.is_authenticated and user.is_vip and item.price and item.price > 0 %}
        {# Usuário VIP tem acesso - Botão Copiar - Apenas ícone #}
        <button
          onclick="
            const btn = this;
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'24\\' height=\\'24\\' viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'2\\' stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\'><circle cx=\\'12\\' cy=\\'12\\' r=\\'10\\'/><polyline points=\\'12 6 12 12 16 14\\'/></svg>';
            
            function copyToClipboard(text) {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
              }
              return new Promise((resolve, reject) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-999999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                try {
                  const successful = document.execCommand('copy');
                  document.body.removeChild(textarea);
                  if (successful) resolve();
                  else reject(new Error('execCommand falhou'));
                } catch (err) {
                  document.body.removeChild(textarea);
                  reject(err);
                }
              });
            }
            
            fetch('{% url 'core:copy_svg' %}?id={{ item.pk }}', {
              method: 'GET',
              headers: { 'Accept': 'application/json' }
            })
            .then(response => {
              if (!response.ok) throw new Error('Erro HTTP: ' + response.status);
              return response.json();
            })
            .then(data => {
              if (data.svg_text) {
                return copyToClipboard(data.svg_text);
              } else {
                throw new Error('SVG não encontrado na resposta');
              }
            })
            .then(() => {
              btn.innerHTML = '<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'24\\' height=\\'24\\' viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'2\\' stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\'><polyline points=\\'20 6 9 17 4 12\\'/></svg>';
              if (typeof showToast === 'function') showToast('SVG copiado com sucesso!', 'success');
              setTimeout(() => { btn.disabled = false; btn.innerHTML = originalHTML; }, 2000);
            })
            .catch(error => {
              console.error('Erro ao copiar:', error);
              if (typeof showToast === 'function') showToast('Erro ao copiar SVG: ' + error.message, 'error');
              btn.disabled = false;
              btn.innerHTML = originalHTML;
            });
          "
          class="btn btn-primary"
          type="button"
          title="Copiar SVG"
          style="padding: 0.75rem; font-size: 0.875rem; font-weight: 600; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;"
          onmouseover="this.style.transform='scale(1.05)'"
          onmouseout="this.style.transform='scale(1)'"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        </button>
      {% elif item.purchased_by_user or purchased %}
        {# Já comprou - Botão Copiar - Apenas ícone #}
        <button
          onclick="
            const btn = this;
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'24\\' height=\\'24\\' viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'2\\' stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\'><circle cx=\\'12\\' cy=\\'12\\' r=\\'10\\'/><polyline points=\\'12 6 12 12 16 14\\'/></svg>';
            
            function copyToClipboard(text) {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
              }
              return new Promise((resolve, reject) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-999999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                try {
                  const successful = document.execCommand('copy');
                  document.body.removeChild(textarea);
                  if (successful) resolve();
                  else reject(new Error('execCommand falhou'));
                } catch (err) {
                  document.body.removeChild(textarea);
                  reject(err);
                }
              });
            }
            
            fetch('{% url 'core:copy_svg' %}?id={{ item.pk }}', {
              method: 'GET',
              headers: { 'Accept': 'application/json' }
            })
            .then(response => {
              if (!response.ok) throw new Error('Erro HTTP: ' + response.status);
              return response.json();
            })
            .then(data => {
              if (data.svg_text) {
                return copyToClipboard(data.svg_text);
              } else {
                throw new Error('SVG não encontrado na resposta');
              }
            })
            .then(() => {
              btn.innerHTML = '<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'24\\' height=\\'24\\' viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'2\\' stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\'><polyline points=\\'20 6 9 17 4 12\\'/></svg>';
              if (typeof showToast === 'function') showToast('SVG copiado com sucesso!', 'success');
              setTimeout(() => { btn.disabled = false; btn.innerHTML = originalHTML; }, 2000);
            })
            .catch(error => {
              console.error('Erro ao copiar:', error);
              if (typeof showToast === 'function') showToast('Erro ao copiar SVG: ' + error.message, 'error');
              btn.disabled = false;
              btn.innerHTML = originalHTML;
            });
          "
          class="btn btn-primary"
          type="button"
          title="Copiar SVG"
          style="padding: 0.75rem; font-size: 0.875rem; font-weight: 600; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;"
          onmouseover="this.style.transform='scale(1.05)'"
          onmouseout="this.style.transform='scale(1)'"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        </button>
      {% elif item.price and item.price > 0 %}
        {# SVG Pago - Botão Adicionar ao Carrinho - Apenas ícone #}
        <button
          onclick="addToCart('{{ item.pk }}', '{{ item.title_name|escapejs }}', {{ item.price }}, 'svg')"
          class="btn btn-primary"
          type="button"
          title="Adicionar ao carrinho"
          style="padding: 0.75rem; font-size: 0.875rem; font-weight: 600; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;"
          onmouseover="this.style.transform='scale(1.05)'"
          onmouseout="this.style.transform='scale(1)'"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
        </button>
      {% else %}
        {# SVG Gratuito - Botão Copiar - Apenas ícone #}
        <button
          onclick="
            const btn = this;
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'24\\' height=\\'24\\' viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'2\\' stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\'><circle cx=\\'12\\' cy=\\'12\\' r=\\'10\\'/><polyline points=\\'12 6 12 12 16 14\\'/></svg>';
            
            function copyToClipboard(text) {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
              }
              return new Promise((resolve, reject) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-999999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                try {
                  const successful = document.execCommand('copy');
                  document.body.removeChild(textarea);
                  if (successful) resolve();
                  else reject(new Error('execCommand falhou'));
                } catch (err) {
                  document.body.removeChild(textarea);
                  reject(err);
                }
              });
            }
            
            fetch('{% url 'core:copy_svg' %}?id={{ item.pk }}', {
              method: 'GET',
              headers: { 'Accept': 'application/json' }
            })
            .then(response => {
              if (!response.ok) throw new Error('Erro HTTP: ' + response.status);
              return response.json();
            })
            .then(data => {
              if (data.svg_text) {
                return copyToClipboard(data.svg_text);
              } else {
                throw new Error('SVG não encontrado na resposta');
              }
            })
            .then(() => {
              btn.innerHTML = '<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'24\\' height=\\'24\\' viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'2\\' stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\'><polyline points=\\'20 6 9 17 4 12\\'/></svg>';
              if (typeof showToast === 'function') showToast('SVG copiado com sucesso!', 'success');
              setTimeout(() => { btn.disabled = false; btn.innerHTML = originalHTML; }, 2000);
            })
            .catch(error => {
              console.error('Erro ao copiar:', error);
              if (typeof showToast === 'function') showToast('Erro ao copiar SVG: ' + error.message, 'error');
              btn.disabled = false;
              btn.innerHTML = originalHTML;
            });
          "
          class="btn btn-primary"
          type="button"
          title="Copiar SVG"
          style="padding: 0.75rem; font-size: 0.875rem; font-weight: 600; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;"
          onmouseover="this.style.transform='scale(1.05)'"
          onmouseout="this.style.transform='scale(1)'"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        </button>
      {% endif %}
    </div>
  </div>

  {# Card Content - Modern Design #}
  <div style="padding: 1.25rem;">
    {# Title and Description #}
    <div style="margin-bottom: 1rem;">
      <h3 style="margin: 0 0 0.25rem 0; font-size: 1.125rem; font-weight: 600; color: var(--text-light); line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical;">
        {{ item.title_name|default:item.filename|default:"SVG sem nome" }}
      </h3>
      <p style="margin: 0; font-size: 0.875rem; color: var(--text-muted); line-height: 1.5; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
        {% if item.description %}{{ item.description }}{% else %}Design de alta qualidade{% endif %}
      </p>
    </div>

    {# Price/Status Row #}
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <div>
        {% if user.is_authenticated and user.is_vip and item.price and item.price > 0 %}
          {# Badge VIP Premium - Apenas ícone de coroa #}
          <span style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: rgba(255, 215, 0, 0.15); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 6px; color: #FFD700;" title="Acesso Premium">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>
          </span>
        {% elif item.purchased_by_user or purchased %}
          {# Badge Owned - Apenas ícone de check #}
          <span style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: rgba(76, 175, 80, 0.15); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 6px; color: #4CAF50;" title="Você possui este SVG">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          </span>
        {% elif item.price and item.price > 0 %}
          {# Preço - Grande e Bold #}
          <span style="font-size: 1.75rem; font-weight: 700; color: var(--primary); letter-spacing: -0.03em;">
            R$ {{ item.price }}
          </span>
        {% else %}
          {# Badge Gratuito - Apenas ícone igual ao SVG free #}
          <span style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: rgba(123, 255, 176, 0.15); border: 1px solid rgba(123, 255, 176, 0.3); border-radius: 6px; color: #7bffb0;" title="Gratuito">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
          </span>
        {% endif %}
      </div>
    </div>
  </div>

  {# Modal de Preview - Alpine.js #}
  <template x-teleport="body">
    <div 
      x-show="showModal" 
      x-cloak
      class="modal-backdrop"
      @click.self="showModal = false"
      @keydown.escape.window="showModal = false"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title-{{ item.pk }}"
      style="display: none;"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
    >
      <div class="modal">
        <div class="modal-header">
          <h3 id="modal-title-{{ item.pk }}">
            {{ item.title_name|default:item.filename|default:"Preview SVG" }}
          </h3>
          <button 
            @click="showModal = false" 
            class="modal-close"
            type="button"
            aria-label="Fechar modal"
          >
            ×
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-preview" data-copy-url="{% url 'core:copy_svg' %}?id={{ item.pk }}">
            <div x-show="svgLoading" class="text-muted">Carregando...</div>
            <div x-html="svgHtml" x-show="!svgLoading"></div>
            <div x-effect="if (showModal && !svgHtml && !svgLoading) { svgLoading = true; var url = $el.closest('[data-copy-url]') ? $el.closest('[data-copy-url]').dataset.copyUrl : null; if (!url) { svgHtml = '<p class=\\'text-muted\\'>URL não disponível</p>'; svgLoading = false; } else { fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } }).then(r => { if (!r.ok) throw r; return r.json() }).then(data => { svgHtml = data.svg_text || '<p class=\\'text-muted\\'>Conteúdo SVG não disponível</p>'; svgLoading = false }).catch(e => { svgHtml = '<p class=\\'text-muted\\'>Erro ao carregar SVG</p>'; svgLoading = false }) } }"></div>
          </div>
          {% if item.description %}
            <p class="mt-4 text-muted">{{ item.description }}</p>
          {% endif %}
        </div>
      </div>
    </div>
  </template>
</div>
