{% load akka_filters %}
{% comment %}
Partial: Card reutilizável para exibir SvgFile (variável: item)
Usa Alpine.js para modal de preview e HTMX para carregar SVG via API
Segurança: usa item.get_sanitized_content que remove <script> e event handlers
{% endcomment %}

<div class="card" id="svg-card-{{ item.pk }}" x-data="{ showModal: false, imgError: false, svgHtml: '', svgLoading: false }" style="background: var(--color-gray-900); border: 1px solid var(--color-gray-800); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.borderColor='var(--color-gray-700)'; this.style.transform='translateY(-4px)'" onmouseout="this.style.borderColor='var(--color-gray-800)'; this.style.transform='translateY(0)'">
  {# Preview do SVG - Aspect ratio 4:3 #}
  <div style="aspect-ratio: 4/3; background: var(--color-gray-800); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;">
    {% if item.thumbnail %}
      <img 
        src="{{ item.thumbnail.url }}" 
        alt="Preview de {{ item.title_name|default:item.filename }}"
        loading="lazy"
        x-show="!imgError"
        @error="imgError = true"
        style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;"
        onmouseover="this.style.transform='scale(1.05)'"
        onmouseout="this.style.transform='scale(1)'"
      >
      <div x-show="imgError" style="display:none; text-align: center; color: var(--text-muted); font-size: 0.875rem;">
        <i data-lucide="image-off" style="width: 48px; height: 48px; margin-bottom: 0.5rem; opacity: 0.5;"></i>
        <p>Sem prévia disponível</p>
      </div>
    {% elif item.content %}
      <img 
        src="data:image/svg+xml;base64,{{ item.get_sanitized_content|base64_encode }}"
        alt="Preview de {{ item.title_name|default:item.filename }}"
        loading="lazy"
        x-show="!imgError"
        @error="imgError = true"
        style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;"
        onmouseover="this.style.transform='scale(1.05)'"
        onmouseout="this.style.transform='scale(1)'"
      >
      <div x-show="imgError" style="display:none; text-align: center; color: var(--text-muted); font-size: 0.875rem;">
        <i data-lucide="image-off" style="width: 48px; height: 48px; margin-bottom: 0.5rem; opacity: 0.5;"></i>
        <p>Erro ao carregar</p>
      </div>
    {% else %}
      <div style="text-align: center; color: var(--text-muted); font-size: 0.875rem;">
        <i data-lucide="image-off" style="width: 48px; height: 48px; margin-bottom: 0.5rem; opacity: 0.5;"></i>
        <p>Sem prévia disponível</p>
      </div>
    {% endif %}
  </div>

  {# Card Content - Modern Design #}
  <div style="padding: 1.25rem;">
    {# Title and Description #}
    <div style="margin-bottom: 1rem;">
      <h3 style="margin: 0 0 0.25rem 0; font-size: 1.125rem; font-weight: 600; color: var(--text-light); line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical;">
        {{ item.title_name|default:item.filename|default:"SVG sem nome" }}
      </h3>
      <p style="margin: 0; font-size: 0.875rem; color: var(--text-muted); line-height: 1.5; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
        {% if item.description %}{{ item.description }}{% else %}Design de alta qualidade{% endif %}
      </p>
    </div>

    {# Price/Status Row #}
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
      <div>
        {% if item.purchased_by_user or purchased or vip_access %}
          {% if vip_access %}
            {# Badge VIP Premium - Discreto #}
            <span style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.625rem; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 4px; font-size: 0.75rem; font-weight: 600; color: #FFD700; text-transform: uppercase; letter-spacing: 0.5px;">
              <i data-lucide="crown" style="width: 12px; height: 12px;"></i>
              Premium
            </span>
          {% else %}
            {# Badge Owned #}
            <span style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.625rem; background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.2); border-radius: 4px; font-size: 0.75rem; font-weight: 600; color: #4CAF50; text-transform: uppercase; letter-spacing: 0.5px;">
              <i data-lucide="check-circle" style="width: 12px; height: 12px;"></i>
              Owned
            </span>
          {% endif %}
        {% elif item.price and item.price > 0 %}
          {# Preço - Grande e Bold #}
          <span style="font-size: 1.75rem; font-weight: 700; color: var(--primary); letter-spacing: -0.03em;">
            R$ {{ item.price }}
          </span>
        {% else %}
          {# Badge Gratuito - Verde #}
          <span style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.875rem; background: rgba(123, 255, 176, 0.12); border-radius: 6px; font-size: 0.875rem; font-weight: 600; color: #7bffb0;">
            <i data-lucide="check" style="width: 14px; height: 14px;"></i>
            Gratuito
          </span>
        {% endif %}
      </div>
    </div>

    {# Action Buttons #}
    <div style="display: flex; gap: 0.625rem;">
      {# Botão Visualizar - Sempre presente #}
      <button 
        @click="showModal = true" 
        class="btn btn-outline"
        type="button"
        style="flex: 1; padding: 0.75rem; font-size: 0.875rem; font-weight: 600; border-radius: 8px; transition: all 0.2s ease;"
      >
        Visualizar
      </button>
      
      {% if item.purchased_by_user or purchased or vip_access %}
        {# Usuário VIP ou já comprou - Botão Copiar #}
        <button
          onclick="
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Copiando...';
            
            function copyToClipboard(text) {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
              }
              return new Promise((resolve, reject) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-999999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                  const successful = document.execCommand('copy');
                  document.body.removeChild(textarea);
                  successful ? resolve() : reject(new Error('Falha ao copiar'));
                } catch (err) {
                  document.body.removeChild(textarea);
                  reject(err);
                }
              });
            }
            
            fetch('{% url 'core:copy_svg' %}?id={{ item.pk }}', {
              headers: { 'Accept': 'application/json' }
            })
            .then(r => r.ok ? r.json() : Promise.reject('Erro HTTP'))
            .then(data => data.svg_text ? copyToClipboard(data.svg_text) : Promise.reject('SVG não encontrado'))
            .then(() => {
              btn.innerHTML = 'Copiado!';
              setTimeout(() => { btn.disabled = false; btn.innerHTML = originalText; }, 2000);
            })
            .catch(error => {
              console.error('Erro:', error);
              if (typeof showToast === 'function') showToast('Erro ao copiar', 'error');
              btn.disabled = false;
              btn.innerHTML = originalText;
            });
          "
          class="btn btn-primary"
          type="button"
          style="flex: 1; padding: 0.75rem; font-size: 0.875rem; font-weight: 600; border-radius: 8px; transition: all 0.2s ease;"
        >
          Copiar
        </button>
      {% elif item.price and item.price > 0 %}
        {# SVG Pago - Botão Adicionar ao Carrinho #}
        <button
          onclick="addToCart('{{ item.pk }}', '{{ item.title_name|escapejs }}', {{ item.price }}, 'svg')"
          class="btn btn-primary"
          type="button"
          style="flex: 1; padding: 0.75rem; font-size: 0.875rem; font-weight: 600; border-radius: 8px; transition: all 0.2s ease;"
        >
          Adicionar
        </button>
      {% else %}
        {# SVG Gratuito - Botão Copiar #}
        <button
          onclick="
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Copiando...';
            
            function copyToClipboard(text) {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
              }
              return new Promise((resolve, reject) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-999999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                  const successful = document.execCommand('copy');
                  document.body.removeChild(textarea);
                  successful ? resolve() : reject(new Error('Falha ao copiar'));
                } catch (err) {
                  document.body.removeChild(textarea);
                  reject(err);
                }
              });
            }
            
            fetch('{% url 'core:copy_svg' %}?id={{ item.pk }}', {
              headers: { 'Accept': 'application/json' }
            })
            .then(r => r.ok ? r.json() : Promise.reject('Erro HTTP'))
            .then(data => data.svg_text ? copyToClipboard(data.svg_text) : Promise.reject('SVG não encontrado'))
            .then(() => {
              btn.innerHTML = 'Copiado!';
              setTimeout(() => { btn.disabled = false; btn.innerHTML = originalText; }, 2000);
            })
            .catch(error => {
              console.error('Erro:', error);
              if (typeof showToast === 'function') showToast('Erro ao copiar', 'error');
              btn.disabled = false;
              btn.innerHTML = originalText;
            });
          "
          class="btn btn-primary"
          type="button"
          style="flex: 1; padding: 0.75rem; font-size: 0.875rem; font-weight: 600; border-radius: 8px; transition: all 0.2s ease;"
        >
          Copiar
        </button>
      {% endif %}
    </div>
  </div>

  {# Modal de Preview - Alpine.js #}
  <template x-teleport="body">
    <div 
      x-show="showModal" 
      x-cloak
      class="modal-backdrop"
      @click.self="showModal = false"
      @keydown.escape.window="showModal = false"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title-{{ item.pk }}"
      style="display: none;"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
    >
      <div class="modal">
        <div class="modal-header">
          <h3 id="modal-title-{{ item.pk }}">
            {{ item.title_name|default:item.filename|default:"Preview SVG" }}
          </h3>
          <button 
            @click="showModal = false" 
            class="modal-close"
            type="button"
            aria-label="Fechar modal"
          >
            ×
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-preview" data-copy-url="{% url 'core:copy_svg' %}?id={{ item.pk }}">
            <!-- Lazy-load do SVG via Ajax/endpoint para evitar injeção direta de markup no DOM -->
            <div x-show="svgLoading" class="text-muted">Carregando...</div>
            <div x-html="svgHtml" x-show="!svgLoading"></div>
            <script type="application/javascript">
              // Alpine effect: quando o modal abrir, buscar o SVG sanitizado uma única vez
              (function(){
                document.addEventListener('alpine:init', () => {
                  // nada aqui — usamos x-effect inline no template abaixo
                })
              })();
            </script>
            <div x-effect="if (showModal && !svgHtml && !svgLoading) { svgLoading = true; var url = $el.closest('[data-copy-url]') ? $el.closest('[data-copy-url]').dataset.copyUrl : null; if (!url) { svgHtml = '<p class=\\'text-muted\\'>URL não disponível</p>'; svgLoading = false; } else { fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } }).then(r => { if (!r.ok) throw r; return r.json() }).then(data => { svgHtml = data.svg_text || '<p class=\\'text-muted\\'>Conteúdo SVG não disponível</p>'; svgLoading = false }).catch(e => { svgHtml = '<p class=\\'text-muted\\'>Erro ao carregar SVG</p>'; svgLoading = false }) } }"></div>
          </div>
          {% if item.description %}
            <p class="mt-4 text-muted">{{ item.description }}</p>
          {% endif %}
        </div>
      </div>
    </div>
  </template>
</div>
