{% load akka_filters %}
{% load l10n %}
{% load static%}
{% comment %}
Partial: Card reutilizável para exibir SvgFile (variável: item)
Usa Alpine.js para modal de preview e HTMX para carregar SVG via API
Segurança: usa item.get_sanitized_content que remove <script> e event handlers
{% endcomment %}

<style>
  /* Hover overlay e escurecimento da thumb */
  /* Tornar o card um flex column para fixar a área da imagem e alinhar o conteúdo inferior */
  .card { display: flex; flex-direction: column; position: relative; overflow: hidden; width: 100%; max-width: 500px; }
  /* Padroniza a área de preview usando aspect-ratio para evitar alterar a altura total do card
    de forma inesperada. O navegador calcula a altura com base na largura disponível, mantendo
    proporção. Ajuste aspect-ratio ou max-height se necessário. */
  /* Usar proporção 1/1 (quadrado) para deixar a área de preview mais alta e uniforme */
  .card-image { position: relative; aspect-ratio: 1/1; max-height: 300px; }
  .card-image img { display:block; width:100%; height:100%; object-fit:cover; transition: filter .18s ease; position: relative; z-index: 0; }
  .card:hover .card-image img, .card-image:hover img { filter: brightness(0.45); }
  /* posiciona o overlay no centro-baixo da thumb */
  .card-overlay { position: absolute; inset: 0; display:flex; align-items:flex-end; justify-content:center; gap:0.85rem; opacity:0; pointer-events:none; transition: opacity .18s ease, transform .18s ease; transform: translateY(10px); z-index: 5; padding-bottom: 0.6rem; }
  .card:hover .card-overlay, .card-image:hover .card-overlay { opacity:1; pointer-events:auto; transform: translateY(0); }
  .overlay-btn { background: rgba(255,255,255,0.06); border: none; width: 2.86rem; height: 2.86rem; border-radius: 50%; display:flex; align-items:center; justify-content:center; color:var(--text-white); backdrop-filter: blur(6px); transition: transform .12s ease, background .12s ease; }
  .overlay-btn:hover { transform: scale(1.08); background: rgba(255,255,255,0.12); }
  .overlay-actions { display:flex; gap:1.2rem; align-items:center; justify-content:center; }
  .favorite-top-right { position: absolute; top: 0.75rem; right: 0.75rem; }
  /* Override específico: neutraliza qualquer transform/scale vindo de folhas de estilo globais
    (fix rápido para evitar "zoom" estático quando outras regras aplicam transform: scale)
    Usamos !important para garantir precedência sem alterar os arquivos globais agora. */
  .card { transform: none !important; }
  .card-image img { transform: none !important; }
  .card:hover { transform: none !important; }
  .card:hover .card-image img { transform: none !important; }
  /* Garantir que .card-content seja referência para badges posicionados */
  .card-content { position: relative; }
  /* Badges (VIP / comprado) posicionadas sem afetar o fluxo do conteúdo
    assim o título não se move quando o badge aparece */
  .card-badges { position: absolute; top: 0.35rem; right: 0.6rem; display:flex; align-items:center; gap:0.4rem; }
  /* Esconder os botões de ação inferiores (vamos expor versões compactas no overlay) */
  .card-content .card-actions-bottom { display: none; }
</style>

<div class="card" id="svg-card-{{ item.pk }}" x-data="{ showModal: false, imgError: false, svgHtml: '', svgLoading: false }">
  {# Botão de Favorito: será exibido dentro do overlay ao passar o mouse sobre a thumb #}
  
  {# Preview do SVG #}
  <div class="card-image">
    {# Overlay de ações que aparece ao passar o mouse #}
    <div class="card-overlay" aria-hidden="true">
      <div class="overlay-actions">
        {% if user.is_authenticated %}
        <button
          class="favorite-btn overlay-btn"
          data-svg-id="{{ item.pk }}"
          onclick="toggleFavorite({{ item.pk }}, this)"
          aria-label="Favoritar SVG {{ item.title_name|default:item.filename }}"
          type="button"
        >
          <span class="favorite-icon" style="display:inline-flex; width:1.375rem; height:1.375rem; align-items:center; justify-content:center;">
            {% if show_favorite %}
              <!-- Favoritado (true) - coração roxo -->
              <svg width="30" height="30" viewBox="0 0 20 18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                <path d="M14.44 0C12.63 0 11.01 0.88 10 2.23C8.99 0.88 7.37 0 5.56 0C2.49 0 0 2.5 0 5.59C0 6.78 0.19 7.88 0.52 8.9C2.1 13.9 6.97 16.89 9.38 17.71C9.72 17.83 10.28 17.83 10.62 17.71C13.03 16.89 17.9 13.9 19.48 8.9C19.81 7.88 20 6.78 20 5.59C20 2.5 17.51 0 14.44 0Z" fill="#7460F3"/>
              </svg>
            {% else %}
              <!-- Não favoritado (false) - PNG preto (se existir). Se não existir, será mostrado fallback SVG preto pelo JS. -->
              <img src="{% static "core/images/heart_preto.png" %}" alt="Favoritar" style="height:18px; width:auto; display:block;" />
            {% endif %}
          </span>
        </button>
        {% endif %}

        {# Botão Visualizar - mantém o comportamento Alpine.js de abrir modal #}
        <button
          class="overlay-btn"
          type="button"
          @click="showModal = true"
          aria-label="Visualizar {{ item.title_name|default:item.filename }}"
        >
          <!-- Ícone de visualizar (olho) -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7z" fill="rgba(0,0,0,0)" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" />
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.4" fill="none" />
          </svg>
        </button>
        {# Ações compactas que aproveitam a lógica já existente nos botões inferiores (#IDs declarados abaixo) #}
        {% if item.purchased_by_user or purchased or vip_access %}
        <button class="overlay-btn btn btn-primary" type="button" aria-label="Copiar SVG" onclick="document.getElementById('copy-btn-{{ item.pk }}') && document.getElementById('copy-btn-{{ item.pk }}').click()" onmouseover="(function(btn){ var i = btn.querySelector('img'); if(i) i.src='{% static 'core/images/Biblioteca.png' %}'; })(this)" onmouseout="(function(btn){ var i = btn.querySelector('img'); if(i) i.src='{% static 'core/images/Biblioteca_preto.png' %}'; })(this)">
          <img src="{% static 'core/images/Biblioteca_preto.png' %}" alt="Copiar" style="height:16px; width:auto; display:inline-block;" />
        </button>
        {% elif item.price > 0 %}
        <button class="overlay-btn btn btn-primary" type="button" aria-label="Adicionar ao carrinho" onclick="document.getElementById('addcart-btn-{{ item.pk }}') && document.getElementById('addcart-btn-{{ item.pk }}').click()" onmouseover="(function(btn){ var i = btn.querySelector('img'); if(i) i.src='{% static 'core/images/Carrinho.png' %}'; })(this)" onmouseout="(function(btn){ var i = btn.querySelector('img'); if(i) i.src='{% static 'core/images/carrinho_preto.png' %}'; })(this)">
          <img src="{% static 'core/images/carrinho_preto.png' %}" alt="Cart" style="width:20px;height:20px;display:block;" />
        </button>
        {% else %}
        <button class="overlay-btn btn btn-primary" type="button" aria-label="Copiar SVG" onclick="document.getElementById('copy-btn-{{ item.pk }}') && document.getElementById('copy-btn-{{ item.pk }}').click()" onmouseover="(function(btn){ var i = btn.querySelector('img'); if(i) i.src='{% static 'core/images/Biblioteca.png' %}'; })(this)" onmouseout="(function(btn){ var i = btn.querySelector('img'); if(i) i.src='{% static 'core/images/Biblioteca_preto.png' %}'; })(this)">
          <img src="{% static 'core/images/Biblioteca_preto.png' %}" alt="Copiar" style="height:16px; width:auto; display:inline-block;" />
        </button>
        {% endif %}
      </div>
    </div>
    {% if item.thumbnail %}
      {# Opção 1: Thumbnail existe - usar URL protegida via guardian #}
      <img 
        src="{{ item.get_thumbnail_url }}" 
        alt="Preview de {{ item.title_name|default:item.filename }}"
        loading="{% if card_index < 4 %}eager{% else %}lazy{% endif %}"
        x-show="!imgError"
        @error="imgError = true"
      >
      <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-gray-500); font-size: 0.875rem; text-align: center;" x-show="imgError">
        Sem prévia<br>disponível
      </div>
    {% elif item.content %}
      {# Opção 2: Sem thumbnail mas tem content - preview inline via data-URI #}
      <img 
        src="data:image/svg+xml;base64,{{ item.get_sanitized_content|base64_encode }}"
        alt="Preview de {{ item.title_name|default:item.filename }}"
        loading="{% if card_index < 4 %}eager{% else %}lazy{% endif %}"
        x-show="!imgError"
        @error="imgError = true"
      >
      <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-gray-500); font-size: 0.875rem; text-align: center;" x-show="imgError">
        Erro ao carregar<br>prévia
      </div>
    {% else %}
      {# Opção 3: Sem thumbnail e sem content - placeholder #}
      <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-gray-500); font-size: 0.875rem; text-align: center;">
        Sem prévia<br>disponível
      </div>
    {% endif %}
  </div>

  {# Conteúdo do card #}
  <div class="card-content" style="padding: 0; margin: 0;">
  <div class="card-badges">
      {# Badge de comprado ou acesso VIP (mantido no topo, alinhado à direita) #}
      {% if vip_access %}
        <span style="display:inline-flex; align-items:center; gap:0.4rem;">
            <img src="{% static 'core/images/Vip.png' %}" alt="VIP" style="height:20px; width:auto; display:inline-block; margin-top:6px;" />
        </span>
      {% elif item.purchased_by_user or purchased %}
        <span class="badge badge-primary" style="font-size: 0.75rem; padding: 0.125rem 0.5rem; background-color: #4CAF50; border-color: #4CAF50;">
          ✓
        </span>
      {% endif %}
    </div>
    
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; gap:0.5rem; transform: translateY(6px);">
      {# Título descido para aqui (substitui o 'by AkkaUi') #}
  <h3 style="color: var(--text-white); font-size: 1.05rem; line-height:0.95; padding-bottom: 0; font-weight: 600; margin: 0; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ item.title_name|default:item.filename }}">
        {{ item.title_name|default:item.filename|default:"SVG sem nome" }}
      </h3>
      
      {# Price ou Free: só mostrar quando NÃO houver badge de comprado/VIP (evita sobreposição) #}
  {% if not item.purchased_by_user and not purchased and not vip_access %}
        {% if item.price > 0 %}
          <span style="color: var(--text-white); font-weight: 600; font-size: 0.875rem;">R$ {{ item.price|floatformat:2 }}</span>
        {% else %}
          <span class="badge badge-primary" style="font-size: 0.7rem;">Free</span>
        {% endif %}
      {% else %}
        {# Quando há badge (comprado/VIP) não mostramos o preço para evitar sobreposição #}
        <span aria-hidden="true"></span>
      {% endif %}
    </div>
    
    {# Ações inferiores removidas (agora expostas no overlay) #}
    <!-- Botões ocultos com IDs usados pelo overlay para disparar a lógica existente -->
    <div style="display:none;" aria-hidden="true">
      {% if item.purchased_by_user or purchased or vip_access %}
        <button id="copy-btn-{{ item.pk }}" class="btn btn-primary" type="button" aria-label="Copiar (oculto)"
          onclick="(function(btn){ const originalHTML = btn.innerHTML; btn.disabled = true; btn.innerHTML = '...'; function copyToClipboard(text){ if(navigator.clipboard && navigator.clipboard.writeText){ return navigator.clipboard.writeText(text); } return new Promise((resolve,reject)=>{ const textarea=document.createElement('textarea'); textarea.value = text; textarea.style.position='fixed'; textarea.style.left='-999999px'; textarea.style.top='-999999px'; document.body.appendChild(textarea); textarea.focus(); textarea.select(); try{ const successful = document.execCommand('copy'); document.body.removeChild(textarea); if(successful) resolve(); else reject(new Error('execCommand falhou')); }catch(e){ document.body.removeChild(textarea); reject(e); } }); }
            fetch('{% url 'core:copy_svg' %}?id={{ item.pk }}', { method: 'GET', headers: { 'Accept': 'application/json' } })
              .then(function(response){ if(!response.ok) throw new Error('Erro HTTP: '+response.status); return response.json(); })
              .then(function(data){ if(data.svg_text) return copyToClipboard(data.svg_text); throw new Error('SVG não encontrado'); })
              .then(function(){ btn.innerHTML = '✓'; if(typeof showNotification==='function') showNotification('SVG copiado com sucesso!', 'success'); setTimeout(function(){ btn.disabled=false; btn.innerHTML = originalHTML; }, 2000); })
              .catch(function(error){ console.error('Erro ao copiar:', error); if(typeof showNotification==='function') showNotification('Erro ao copiar SVG: ' + error.message, 'error'); else alert('Erro ao copiar SVG: ' + error.message); btn.disabled=false; btn.innerHTML = originalHTML; }); })(this)">
          hidden
        </button>
      {% endif %}
      {% if item.price > 0 %}
        <button id="addcart-btn-{{ item.pk }}" onclick="addToCart({{ item.pk }}, '{{ item.title_name|escapejs }}', {{ item.price|unlocalize }})" class="btn btn-primary" type="button" aria-label="Adicionar ao carrinho (oculto)">hidden</button>
      {% endif %}
      {% if not item.price or item.price <= 0 %}
        {# Para itens gratuitos, também expor copy-btn caso não exista acima #}
        <button id="copy-btn-{{ item.pk }}" class="btn btn-primary" type="button" aria-label="Copiar (oculto)"
          onclick="(function(btn){ const originalHTML = btn.innerHTML; btn.disabled = true; btn.innerHTML = '...'; function copyToClipboard(text){ if(navigator.clipboard && navigator.clipboard.writeText){ return navigator.clipboard.writeText(text); } return new Promise((resolve,reject)=>{ const textarea=document.createElement('textarea'); textarea.value = text; textarea.style.position='fixed'; textarea.style.left='-999999px'; textarea.style.top='-999999px'; document.body.appendChild(textarea); textarea.focus(); textarea.select(); try{ const successful = document.execCommand('copy'); document.body.removeChild(textarea); if(successful) resolve(); else reject(new Error('execCommand falhou')); }catch(e){ document.body.removeChild(textarea); reject(e); } }); }
            fetch('{% url 'core:copy_svg' %}?id={{ item.pk }}', { method: 'GET', headers: { 'Accept': 'application/json' } })
              .then(function(response){ if(!response.ok) throw new Error('Erro HTTP: '+response.status); return response.json(); })
              .then(function(data){ if(data.svg_text) return copyToClipboard(data.svg_text); throw new Error('SVG não encontrado'); })
              .then(function(){ btn.innerHTML = '✓'; if(typeof showNotification==='function') showNotification('SVG copiado com sucesso!', 'success'); setTimeout(function(){ btn.disabled=false; btn.innerHTML = originalHTML; }, 2000); })
              .catch(function(error){ console.error('Erro ao copiar:', error); if(typeof showNotification==='function') showNotification('Erro ao copiar SVG: ' + error.message, 'error'); else alert('Erro ao copiar SVG: ' + error.message); btn.disabled=false; btn.innerHTML = originalHTML; }); })(this)">
          hidden
        </button>
      {% endif %}
    </div>
  </div>

  {# Modal de Preview - Alpine.js #}
  <template x-teleport="body">
    <div 
      x-show="showModal" 
      x-cloak
      class="modal-backdrop"
      @click.self="showModal = false"
      @keydown.escape.window="showModal = false"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title-{{ item.pk }}"
      style="display: none;"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
    >
      <div class="modal">
        <div class="modal-header">
          <h3 id="modal-title-{{ item.pk }}">
            {{ item.title_name|default:item.filename|default:"Preview SVG" }}
          </h3>
          <button 
            @click="showModal = false" 
            class="modal-close"
            type="button"
            aria-label="Fechar modal"
          >
            ×
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-grid" style="display:flex; gap:1rem; align-items:flex-start;">
            <div class="modal-preview-wrap" style="flex:1; min-width:0;">
              <div class="modal-preview" data-copy-url="{% url 'core:copy_svg' %}?id={{ item.pk }}">
                {% if item.thumbnail %}
                  <img src="{{ item.get_thumbnail_url }}" alt="Preview de {{ item.title_name|default:item.filename }}" style="width:100%; height:auto; max-height:70vh; object-fit:contain; display:block;" />
                {% elif item.content %}
                  <div x-show="svgLoading" class="text-muted">Carregando...</div>
                  <div x-html="svgHtml" x-show="!svgLoading" style="max-width:100%; max-height:70vh; overflow:auto;"></div>
                  <div x-effect='if (showModal && !svgHtml && !svgLoading) { svgLoading = true; var url = $el.closest("[data-copy-url]") ? $el.closest("[data-copy-url]").dataset.copyUrl : null; if (!url) { svgHtml = "<p class=\"text-muted\">URL não disponível</p>"; svgLoading = false; } else { fetch(url, { method: "GET", headers: { "Accept": "application/json" } }).then(r => { if (!r.ok) throw r; return r.json() }).then(data => { svgHtml = data.svg_text || "<p class=\"text-muted\">Conteúdo SVG não disponível</p>"; svgLoading = false }).catch(e => { svgHtml = "<p class=\"text-muted\">Erro ao carregar SVG</p>"; svgLoading = false }) } }'></div>
                {% else %}
                  <p class="text-muted">Sem prévia disponível</p>
                {% endif %}
              </div>
            </div>

            <div class="modal-meta" style="width:320px; max-width:40%; display:flex; flex-direction:column; gap:0.75rem;">
              <div style="display:flex; gap:0.5rem;">
                {% if item.purchased_by_user or purchased or vip_access %}
                  <button type="button" class="btn btn-primary" onclick="(function(btn){ btn.disabled=true; const modal = btn.closest('.modal'); const url = modal.querySelector('[data-copy-url]') ? modal.querySelector('[data-copy-url]').dataset.copyUrl : null; if(!url){ alert('URL não disponível'); btn.disabled=false; return; } fetch(url,{ method:'GET', headers:{ 'Accept':'application/json' } }).then(r=>{ if(!r.ok) throw r; return r.json(); }).then(data=>{ const text = data.svg_text||''; if(navigator.clipboard && navigator.clipboard.writeText){ return navigator.clipboard.writeText(text); } const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }).then(()=>{ if(typeof showNotification==='function') showNotification('SVG copiado!', 'success'); btn.disabled=false; }).catch(e=>{ console.error(e); if(typeof showNotification==='function') showNotification('Erro ao copiar', 'error'); else alert('Erro ao copiar SVG'); btn.disabled=false; }); })(this)">Copiar</button>
                  <button type="button" class="btn btn-secondary" onclick="(function(btn){ btn.disabled=true; const modal = btn.closest('.modal'); const url = modal.querySelector('[data-copy-url]') ? modal.querySelector('[data-copy-url]').dataset.copyUrl : null; if(!url){ alert('URL não disponível'); btn.disabled=false; return; } fetch(url,{ method:'GET', headers:{ 'Accept':'application/json' } }).then(r=>{ if(!r.ok) throw r; return r.json(); }).then(data=>{ const svg = data.svg_text||''; const a=document.createElement('a'); a.href = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg); a.download = '{{ item.filename|default:item.title_name|default:"svg" }}.svg'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }).then(()=>{ btn.disabled=false; }).catch(e=>{ console.error(e); alert('Erro ao baixar SVG'); btn.disabled=false; }); })(this)">Download</button>
                {% elif item.price > 0 %}
                  <button type="button" class="btn btn-primary" onclick="addToCart({{ item.pk }}, '{{ item.title_name|escapejs }}', {{ item.price|unlocalize }} )">Adicionar ao carrinho</button>
                {% else %}
                  <button type="button" class="btn btn-primary" onclick="(function(btn){ btn.disabled=true; const modal = btn.closest('.modal'); const url = modal.querySelector('[data-copy-url]') ? modal.querySelector('[data-copy-url]').dataset.copyUrl : null; if(!url){ alert('URL não disponível'); btn.disabled=false; return; } fetch(url,{ method:'GET', headers:{ 'Accept':'application/json' } }).then(r=>{ if(!r.ok) throw r; return r.json(); }).then(data=>{ const text = data.svg_text||''; if(navigator.clipboard && navigator.clipboard.writeText){ return navigator.clipboard.writeText(text); } const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }).then(()=>{ if(typeof showNotification==='function') showNotification('SVG copiado!', 'success'); btn.disabled=false; }).catch(e=>{ console.error(e); if(typeof showNotification==='function') showNotification('Erro ao copiar', 'error'); else alert('Erro ao copiar SVG'); btn.disabled=false; }); })(this)">Copiar</button>
                  <button type="button" class="btn btn-secondary" onclick="(function(btn){ btn.disabled=true; const modal = btn.closest('.modal'); const url = modal.querySelector('[data-copy-url]') ? modal.querySelector('[data-copy-url]').dataset.copyUrl : null; if(!url){ alert('URL não disponível'); btn.disabled=false; return; } fetch(url,{ method:'GET', headers:{ 'Accept':'application/json' } }).then(r=>{ if(!r.ok) throw r; return r.json(); }).then(data=>{ const svg = data.svg_text||''; const a=document.createElement('a'); a.href = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg); a.download = '{{ item.filename|default:item.title_name|default:"svg" }}.svg'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }).then(()=>{ btn.disabled=false; }).catch(e=>{ console.error(e); alert('Erro ao baixar SVG'); btn.disabled=false; }); })(this)">Download</button>
                {% endif %}
              </div>

              <div style="font-weight:600;">{{ item.title_name|default:item.filename|default:"SVG sem nome" }}</div>
              <div style="color:var(--text-gray-400); font-size:0.95rem;">by AkkaUi</div>
              {% if item.description %}
                <div style="margin-top:0.5rem; color: var(--text-gray-400);">{{ item.description }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>
</div>
