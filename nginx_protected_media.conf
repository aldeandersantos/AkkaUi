# Configuração Nginx para arquivos protegidos com X-Accel-Redirect
# 
# Este arquivo deve ser incluído na configuração do seu servidor Nginx.
# Exemplo de uso no bloco server:
#
# server {
#     listen 80;
#     server_name example.com;
#     
#     # ... outras configurações ...
#     
#     # Proxy para Django
#     location / {
#         proxy_pass http://127.0.0.1:8000;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
#     
#     # Incluir este arquivo
#     include /path/to/nginx_protected_media.conf;
# }

# Bloco location interno para servir arquivos protegidos
# A diretiva 'internal' garante que esta localização só pode ser acessada
# via redirecionamento interno (X-Accel-Redirect), não diretamente pelos clientes
location /internal_media/ {
    # Apenas acessível internamente via X-Accel-Redirect
    internal;
    
    # Mapeia para o diretório real onde os arquivos estão armazenados
    # Ajuste o caminho abaixo para corresponder ao seu MEDIA_ROOT
    alias /path/to/your/project/media/;
    
    # Exemplo de caminho absoluto:
    # alias /home/user/AkkaUi/media/;
    
    # Ou usando variável de ambiente (requer configuração adicional):
    # alias $media_root/;
}

# IMPORTANTE: Bloqueio de acesso direto a arquivos de mídia
# Todos os arquivos de mídia (incluindo thumbnails) agora são protegidos via guardian
# e devem ser acessados através das views Django que verificam permissões
location /media/ {
    # Retorna 403 (Forbidden) para acesso direto
    # Isso garante que:
    # - Thumbnails só podem ser acessadas via /guardian/thumbnail/<id>/
    # - FileAssets só podem ser acessados via /guardian/download/<id>/
    # - SVGs privados ou pagos ficam protegidos
    return 403;
    
    # NOTA: Se você precisar servir alguns arquivos públicos estáticos (ex: logos),
    # crie uma pasta separada fora do MEDIA_ROOT (ex: /static/public/) e sirva-a
    # diretamente via Nginx sem passar pelo Django
}
