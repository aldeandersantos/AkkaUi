{% load akka_filters %}
{% comment %}
Partial: Card reutiliz√°vel para exibir SvgFile (vari√°vel: item)
Usa Alpine.js para modal de preview e HTMX para carregar SVG via API
Seguran√ßa: usa item.get_sanitized_content que remove <script> e event handlers
{% endcomment %}

<div class="card" id="svg-card-{{ item.pk }}" x-data="{ showModal: false, imgError: false }">
  {# Preview do SVG #}
  <div class="svg-thumb">
    {% if item.thumbnail %}
      {# Op√ß√£o 1: Thumbnail existe - usar imagem #}
      <img 
        src="{{ item.thumbnail.url }}" 
        alt="Preview de {{ item.title_name|default:item.filename }}"
        loading="lazy"
        x-show="!imgError"
        @error="imgError = true"
      >
      <div class="svg-thumb-placeholder" x-show="imgError" style="display:none;">
        Sem pr√©via<br>dispon√≠vel
      </div>
    {% elif item.content %}
      {# Op√ß√£o 2: Sem thumbnail mas tem content - preview inline via data-URI #}
      {# Usa data-URI para evitar execu√ß√£o de scripts #}
      <img 
        src="data:image/svg+xml;base64,{{ item.get_sanitized_content|base64_encode }}"
        alt="Preview de {{ item.title_name|default:item.filename }}"
        loading="lazy"
        x-show="!imgError"
        @error="imgError = true"
      >
      <div class="svg-thumb-placeholder" x-show="imgError" style="display:none;">
        Erro ao carregar<br>pr√©via
      </div>
    {% else %}
      {# Op√ß√£o 3: Sem thumbnail e sem content - placeholder #}
      <div class="svg-thumb-placeholder">
        Sem pr√©via<br>dispon√≠vel
      </div>
    {% endif %}
  </div>

  {# Informa√ß√µes do card #}
  <h3 class="card-title" title="{{ item.title_name|default:item.filename }}">
    {{ item.title_name|default:item.filename|default:"SVG sem nome" }}
  </h3>
  
  {% if item.description %}
    <p class="card-description" title="{{ item.description }}">
      {{ item.description }}
    </p>
  {% else %}
    <p class="card-description text-muted">
      Sem descri√ß√£o dispon√≠vel
    </p>
  {% endif %}

  {# A√ß√µes #}
  <div class="card-actions">
    {# Bot√£o Visualizar - abre modal com Alpine.js #}
    <button 
      @click="showModal = true" 
      class="btn btn-accent"
      type="button"
      aria-label="Visualizar {{ item.title_name|default:item.filename }}"
    >
      üëÅÔ∏è Visualizar
    </button>
    
    {# Bot√£o Copiar - usa fetch com fallback para clipboard #}
    <button
      onclick="
        const btn = this;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Copiando...';
        
        // Fun√ß√£o para copiar com fallback
        function copyToClipboard(text) {
          // Tentar usar a Clipboard API moderna
          if (navigator.clipboard && navigator.clipboard.writeText) {
            return navigator.clipboard.writeText(text);
          }
          
          // Fallback para navegadores mais antigos ou HTTP
          return new Promise((resolve, reject) => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-999999px';
            textarea.style.top = '-999999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            
            try {
              const successful = document.execCommand('copy');
              document.body.removeChild(textarea);
              if (successful) {
                resolve();
              } else {
                reject(new Error('execCommand falhou'));
              }
            } catch (err) {
              document.body.removeChild(textarea);
              reject(err);
            }
          });
        }
        
        fetch('{% url 'core:copy_svg' %}?id={{ item.pk }}', {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Erro HTTP: ' + response.status);
          }
          return response.json();
        })
        .then(data => {
          if (data.svg_text) {
            return copyToClipboard(data.svg_text);
          } else {
            throw new Error('SVG n√£o encontrado na resposta');
          }
        })
        .then(() => {
          btn.textContent = '‚úì Copiado!';
          setTimeout(() => {
            btn.disabled = false;
            btn.textContent = originalText;
          }, 2000);
        })
        .catch(error => {
          console.error('Erro ao copiar:', error);
          alert('Erro ao copiar SVG: ' + error.message);
          btn.disabled = false;
          btn.textContent = originalText;
        });
      "
      class="btn btn-secondary"
      type="button"
      aria-label="Copiar SVG {{ item.title_name|default:item.filename }}"
    >
      üìã Copiar
    </button>
  </div>

  {# Modal de Preview - Alpine.js #}
  <template x-teleport="body">
    <div 
      x-show="showModal" 
      x-cloak
      class="modal-backdrop"
      @click.self="showModal = false"
      @keydown.escape.window="showModal = false"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title-{{ item.pk }}"
      style="display: none;"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
    >
      <div class="modal">
        <div class="modal-header">
          <h3 id="modal-title-{{ item.pk }}">
            {{ item.title_name|default:item.filename|default:"Preview SVG" }}
          </h3>
          <button 
            @click="showModal = false" 
            class="modal-close"
            type="button"
            aria-label="Fechar modal"
          >
            √ó
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-preview">
            {% if item.content %}
              {# 
                Renderiza SVG inline no modal 
                SEGURAN√áA: usa get_sanitized_content que remove <script> e event handlers (sanitiza√ß√£o m√≠nima)
                TODO futuro: implementar sanitiza√ß√£o robusta com whitelist de tags/attrs
              #}
              {{ item.get_sanitized_content|safe }}
            {% else %}
              <p class="text-muted">Conte√∫do SVG n√£o dispon√≠vel</p>
            {% endif %}
          </div>
          {% if item.description %}
            <p class="mt-4 text-muted">{{ item.description }}</p>
          {% endif %}
        </div>
      </div>
    </div>
  </template>
</div>
