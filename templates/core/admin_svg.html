{% extends 'core/base.html' %}

{% block title %}Admin - Gerenciar SVGs — AkkaUi{% endblock %}

{% block content %}
  <article class="page">
    <header class="page-header">
      <h1>Gerenciar SVGs</h1>
      <p class="lead">Sistema administrativo para criação e gerenciamento de arquivos SVG.</p>
    </header>

    <div class="page-body">
      <section id="create-svg" style="margin-bottom:2rem">
        <h2>Criar Novo SVG</h2>
        <p class="muted">Preencha as informações abaixo para criar um novo SVG no banco de dados.</p>

        <form id="admin-svg-form" style="margin-top:1.5rem">
          <div style="display:flex; flex-direction:column; gap:1rem; max-width:800px">
            
            <!-- Title Name -->
            <div style="display:flex; flex-direction:column; gap:.5rem">
              <label for="title_name" style="font-weight:600; color:var(--text-light)">
                Título
              </label>
              <input 
                id="title_name" 
                name="title_name" 
                type="text" 
                placeholder="ex: Ícone de Usuário"
                style="padding:.75rem 1rem; background:var(--bg-card); color:var(--text-light); border:1px solid var(--border); border-radius:8px; font-size:1rem"
              />
            </div>

            <!-- Description -->
            <div style="display:flex; flex-direction:column; gap:.5rem">
              <label for="description" style="font-weight:600; color:var(--text-light)">
                Descrição
              </label>
              <textarea 
                id="description" 
                name="description" 
                rows="3"
                placeholder="Descreva o SVG..."
                style="padding:.75rem 1rem; background:var(--bg-card); color:var(--text-light); border:1px solid var(--border); border-radius:8px; font-size:1rem; font-family:inherit; resize:vertical"
              ></textarea>
            </div>

            <!-- Tags -->
            <div style="display:flex; flex-direction:column; gap:.5rem">
              <label for="tags" style="font-weight:600; color:var(--text-light)">
                Tags
              </label>
              <input 
                id="tags" 
                name="tags" 
                type="text" 
                placeholder="ex: icone, usuario, perfil (separadas por vírgula)"
                style="padding:.75rem 1rem; background:var(--bg-card); color:var(--text-light); border:1px solid var(--border); border-radius:8px; font-size:1rem"
              />
              <small class="muted">Separe as tags por vírgula</small>
            </div>

            <!-- Category -->
            <div style="display:flex; flex-direction:column; gap:.5rem">
              <label for="category" style="font-weight:600; color:var(--text-light)">
                Categoria
              </label>
              <input 
                id="category" 
                name="category" 
                type="text" 
                placeholder="ex: Ícones"
                style="padding:.75rem 1rem; background:var(--bg-card); color:var(--text-light); border:1px solid var(--border); border-radius:8px; font-size:1rem"
              />
            </div>

            <!-- Thumbnail -->
            <div style="display:flex; flex-direction:column; gap:.5rem">
              <label for="thumbnail" style="font-weight:600; color:var(--text-light)">
                Thumbnail (Imagem de Prévia)
              </label>
              <input 
                id="thumbnail" 
                name="thumbnail" 
                type="file" 
                accept="image/*"
                style="padding:.75rem 1rem; background:var(--bg-card); color:var(--text-light); border:1px solid var(--border); border-radius:8px; font-size:1rem"
              />
              <small class="muted">Opcional: adicione uma imagem de prévia</small>
            </div>

            <!-- SVG Content -->
            <div style="display:flex; flex-direction:column; gap:.5rem">
              <label for="svg_text" style="font-weight:600; color:var(--text-light)">
                Conteúdo SVG <span style="color:#ff7b7b">*</span>
              </label>
              <div style="display:flex; gap:.5rem; margin-bottom:.5rem">
                <!--
                Botão comentado para ajuste posterior
                <button type="button" id="btn-paste-clipboard" class="btn btn-secondary">
                  Colar do Clipboard
                </button> -->
                <button type="button" id="btn-load-file" class="btn btn-secondary">
                  Carregar Arquivo SVG
                </button>
                <input type="file" id="svg-file-input" accept=".svg,image/svg+xml" style="display:none" />
              </div>
              <textarea 
                id="svg_text" 
                name="svg_text" 
                rows="12"
                required
                placeholder="Cole o código SVG aqui... <svg>...</svg>"
                style="padding:1rem; background:var(--bg-card); color:var(--text-light); border:1px solid var(--border); border-radius:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:.9rem; resize:vertical"
              ></textarea>
            </div>

            <!-- Checkboxes -->
            <div style="display:flex; flex-direction:column; gap:.75rem">
              <label style="display:flex; align-items:center; gap:.5rem; cursor:pointer">
                <input type="checkbox" id="is_public" name="is_public" style="width:18px; height:18px; cursor:pointer" />
                <span style="font-weight:500">Tornar público</span>
              </label>
              
              <label style="display:flex; align-items:center; gap:.5rem; cursor:pointer">
                <input type="checkbox" id="license_required" name="license_required" style="width:18px; height:18px; cursor:pointer" />
                <span style="font-weight:500">Requer licença</span>
              </label>
            </div>

            <!-- Submit Button -->
            <div style="display:flex; gap:1rem; align-items:center; margin-top:1rem">
              <button type="submit" class="btn btn-primary" style="padding:.75rem 2rem; font-size:1rem">
                Criar SVG
              </button>
              <span id="form-status" class="muted"></span>
            </div>
          </div>
        </form>
      </section>

      <hr style="border-color:var(--border); margin:2rem 0" />

      <section id="my-svgs">
        <h2>Meus SVGs</h2>
        {% if svgfiles %}
          <div style="margin-top:1rem; display:flex; flex-direction:column; gap:.75rem">
            {% for svg in svgfiles %}
              <div class="svg-item" style="padding:1rem; border:1px solid var(--border); border-radius:8px; background:var(--bg-card)">
                <div style="display:flex; justify-content:space-between; align-items:start; gap:1rem">
                  <div style="flex:1">
                    <h3 style="margin:0 0 .5rem; color:var(--text-light)">
                      {{ svg.title_name|default:"SVG" }}
                    </h3>
                    <div style="font-size:.9rem; color:var(--text-muted); margin-bottom:.5rem">
                      <strong>Nome:</strong> {{ svg.title_name|default:"-" }}
                    </div>
                    {% if svg.description %}
                      <p class="muted" style="margin:.5rem 0">{{ svg.description }}</p>
                    {% endif %}
                    {% if svg.tags %}
                      <div style="margin-top:.5rem">
                        <span style="padding:.25rem .5rem; background:var(--bg-dark); border:1px solid var(--border); border-radius:4px; font-size:.85rem">
                          {{ svg.tags }}
                        </span>
                      </div>
                    {% endif %}
                    <div style="margin-top:.5rem; font-size:.85rem; color:var(--text-muted)">
                      Criado em: {{ svg.uploaded_at|date:"d/m/Y H:i" }}
                    </div>
                  </div>
                  <div style="display:flex; gap:.5rem">
                    <button class="btn btn-secondary btn-copy-svg" data-id="{{ svg.id }}">
                      Copiar
                    </button>
                    <!-- Delete button -->
                    <button title="Excluir SVG" class="btn btn-danger btn-delete-svg" data-id="{{ svg.id }}" style="display:inline-flex; align-items:center; justify-content:center; padding:.5rem;">
                      <!-- simples ícone de lixeira em SVG -->
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8 6v14a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M10 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted" style="margin-top:1rem">Você ainda não criou nenhum SVG.</p>
        {% endif %}
      </section>
    </div>
  </article>

  <script>
    (function() {
      const form = document.getElementById('admin-svg-form');
      const formStatus = document.getElementById('form-status');
      const svgTextarea = document.getElementById('svg_text');
      const btnPaste = document.getElementById('btn-paste-clipboard');
      const btnLoadFile = document.getElementById('btn-load-file');
      const svgFileInput = document.getElementById('svg-file-input');
      const createUrl = "{% url 'core:admin_create_svg' %}";
      const copyUrl = "{% url 'core:copy_svg' %}";
  const deleteUrl = "{% url 'core:admin_delete_svg' %}";

      function setStatus(msg, isError = false) {
        formStatus.textContent = msg;
        formStatus.style.color = isError ? '#ff7b7b' : '#7bffb0';
        if (msg) {
          setTimeout(() => {
            formStatus.textContent = '';
          }, 5000);
        }
      }

      // Paste from clipboard
      btnPaste?.addEventListener('click', async () => {
        try {
          setStatus('Lendo do clipboard...');
          let text = '';
          
          // Try modern clipboard API first
          if (navigator.clipboard && navigator.clipboard.read) {
            try {
              const items = await navigator.clipboard.read();
              for (const item of items) {
                if (item.types.includes('image/svg+xml')) {
                  const blob = await item.getType('image/svg+xml');
                  text = await blob.text();
                  break;
                }
                if (item.types.includes('text/plain')) {
                  const blob = await item.getType('text/plain');
                  text = await blob.text();
                  break;
                }
              }
            } catch (e) {
              // Fall back to readText
            }
          }
          
          // Fallback to simple readText
          if (!text && navigator.clipboard && navigator.clipboard.readText) {
            text = await navigator.clipboard.readText();
          }
          
          if (!text) {
            throw new Error('Clipboard vazio ou não suportado');
          }
          
          if (!text.trim().toLowerCase().includes('<svg')) {
            setStatus('Aviso: O conteúdo do clipboard não parece ser um SVG', true);
          }
          
          svgTextarea.value = text;
          setStatus('Conteúdo colado do clipboard');
          
          // Não usamos mais campo filename; opcionalmente preencher title_name se quiser
          const titleInput = document.getElementById('title_name');
          if (titleInput && !titleInput.value) {
            titleInput.value = 'clipboard';
          }
        } catch (err) {
          setStatus('Erro ao ler do clipboard: ' + err.message, true);
        }
      });

      // Load from file
      btnLoadFile?.addEventListener('click', () => {
        svgFileInput?.click();
      });

      svgFileInput?.addEventListener('change', (ev) => {
        const file = ev.target.files?.[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = () => {
          const text = reader.result;
          if (!text.trim().toLowerCase().includes('<svg')) {
            setStatus('Aviso: O arquivo não parece ser um SVG válido', true);
          }
          svgTextarea.value = text;
          setStatus('Arquivo carregado: ' + file.name);
          
          // Não usamos mais campo filename; opcionalmente preencher title_name se vazio
          const titleInput = document.getElementById('title_name');
          if (titleInput && !titleInput.value) {
            titleInput.value = file.name || '';
          }
        };
        reader.onerror = () => {
          setStatus('Erro ao ler arquivo', true);
        };
        reader.readAsText(file);
        ev.target.value = ''; // Reset input
      });

      // Form submission
      form?.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        
        submitBtn.disabled = true;
        setStatus('Criando SVG...');
        
        try {
          const response = await fetch(createUrl, { method: 'POST', body: formData, headers: { 'X-CSRFToken': '{{ csrf_token }}' } });
          async function parseJsonOrText(response) {
            const ct = response.headers.get('content-type') || '';
            if (ct.includes('application/json')) return await response.json();
            return { __raw_text: await response.text() };
          }
          const data = await parseJsonOrText(response);
          if (!response.ok) {
            throw new Error((data && (data.error || data.__raw_text)) || 'Erro ao criar SVG');
          }
          setStatus('SVG criado com sucesso!');
          
          // Reset form
          form.reset();
          
          // Reload page after a brief delay to show the new SVG
          setTimeout(() => {
            window.location.reload();
          }, 1000);
          
        } catch (err) {
          setStatus('Erro: ' + err.message, true);
        } finally {
          submitBtn.disabled = false;
        }
      });

      // Copy SVG functionality
      document.addEventListener('click', async (ev) => {
        const btn = ev.target.closest('.btn-copy-svg');
        if (!btn) return;
        
        const id = btn.dataset.id;
        if (!id) return;
        
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = 'Copiando...';
        
        try {
          const url = copyUrl + '?id=' + encodeURIComponent(id);
          const response = await fetch(url);
          const ct = response.headers.get('content-type') || '';
          let data;
          if (ct.includes('application/json')) data = await response.json(); else data = { __raw_text: await response.text() };
          if (!response.ok) throw new Error((data && (data.error || data.__raw_text)) || 'Erro ao copiar');
          await safeCopy(data.svg_text || data.__raw_text || '');
          btn.textContent = 'Copiado!';
          
          setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          }, 2000);
        } catch (err) {
          alert('Erro ao copiar: ' + err.message);
          btn.textContent = originalText;
          btn.disabled = false;
        }
      });

      // Delete SVG functionality
      document.addEventListener('click', async (ev) => {
        const btn = ev.target.closest('.btn-delete-svg');
        if (!btn) return;

        const id = btn.dataset.id;
        if (!id) return;

        // confirmação simples
        if (!confirm('Tem certeza que deseja excluir este SVG? Esta ação não pode ser desfeita.')) return;

        btn.disabled = true;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '...';

        try {
          // tenta obter CSRF do cookie e enviar DELETE
          const csrftoken = getCookie('csrftoken');
          const url = deleteUrl + '?id=' + encodeURIComponent(id);
          const response = await fetch(url, {
            method: 'DELETE',
            headers: {
              'X-CSRFToken': csrftoken || '',
              'Accept': 'application/json',
            },
            credentials: 'same-origin'
          });

          let data;
          const ct = response.headers.get('content-type') || '';
          if (ct.includes('application/json')) data = await response.json(); else data = { __raw_text: await response.text() };

          if (!response.ok) throw new Error((data && (data.error || data.__raw_text)) || 'Erro ao excluir');

          // remover do DOM
          const item = btn.closest('.svg-item');
          if (item) {
            item.remove();
          }

        } catch (err) {
          alert('Erro ao excluir: ' + err.message);
          btn.disabled = false;
          btn.innerHTML = originalHtml;
        }
      });

      // util: pegar cookie (para CSRF)
      function getCookie(name) {
        const cookies = document.cookie ? document.cookie.split(';') : [];
        for (let i = 0; i < cookies.length; i++) {
          const c = cookies[i].trim();
          if (c.startsWith(name + '=')) {
            return decodeURIComponent(c.substring(name.length + 1));
          }
        }
        return null;
      }

      // safeCopy util (fallback para navegadores/contexts sem navigator.clipboard)
      async function safeCopy(text) {
        if (!text) return;
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            return await navigator.clipboard.writeText(text);
          }
        } catch (e) {
          // continua para fallback
        }
        return new Promise((resolve, reject) => {
          try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.setAttribute('readonly', '');
            ta.style.position = 'absolute';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            const ok = document.execCommand && document.execCommand('copy');
            document.body.removeChild(ta);
            if (ok) resolve(); else reject(new Error('Fallback copy falhou'));
          } catch (err) {
            reject(err);
          }
        });
      }
    })();
  </script>
{% endblock %}
