# ============================================================================
# Configuração Nginx para Arquivos Protegidos com X-Accel-Redirect
# ============================================================================
# 
# Este arquivo configura o Nginx para servir arquivos de mídia protegidos
# do Django de forma eficiente e segura usando X-Accel-Redirect.
#
# IMPORTANTE: Ajuste os caminhos conforme seu ambiente antes de usar!
#
# ============================================================================

# Exemplo de configuração completa do servidor Nginx
# Copie e ajuste conforme necessário

server {
    listen 80;
    server_name seu-dominio.com;
    
    # Tamanho máximo de upload (ajuste conforme necessário)
    client_max_body_size 50M;
    
    # Logs (ajuste os caminhos)
    access_log /var/log/nginx/akkaui_access.log;
    error_log /var/log/nginx/akkaui_error.log;
    
    # Servir arquivos estáticos diretamente (após collectstatic)
    location /static/ {
        alias /home/user/AkkaUi/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # ========================================================================
    # CONFIGURAÇÃO CRÍTICA: Location interno para X-Accel-Redirect
    # ========================================================================
    # Esta location é INTERNA - só acessível via X-Accel-Redirect do Django
    # Nginx serve os arquivos diretamente do disco após Django validar permissões
    location /internal_media/ {
        # CRÍTICO: Mantém esta location interna (não acessível externamente)
        internal;
        
        # AJUSTE ESTE CAMINHO para seu MEDIA_ROOT
        # Deve apontar para o diretório onde Django armazena arquivos de mídia
        alias /home/user/AkkaUi/media/;
        
        # Exemplos de caminhos comuns:
        # alias /var/www/akkaui/media/;
        # alias /opt/akkaui/media/;
        # alias /home/deploy/AkkaUi/media/;
        
        # Headers de cache para thumbnails (opcional)
        expires 7d;
        add_header Cache-Control "private";
    }
    
    # ========================================================================
    # BLOQUEIO DE SEGURANÇA: Acesso direto a /media/ retorna 403
    # ========================================================================
    # Todos os arquivos de mídia DEVEM ser acessados via Django
    # Django valida permissões e retorna X-Accel-Redirect para Nginx servir
    location /media/ {
        # Retorna 403 (Forbidden) para acesso direto
        # Isso garante que:
        # - Thumbnails só podem ser acessadas via /guardian/thumbnail/<id>/
        # - FileAssets só podem ser acessados via /guardian/download/<id>/
        # - SVGs privados e pagos ficam protegidos
        return 403;
    }
    
    # ========================================================================
    # Proxy para Django/Gunicorn
    # ========================================================================
    location / {
        # Ajuste a porta se necessário (Gunicorn padrão: 8000)
        proxy_pass http://127.0.0.1:8000;
        
        # Headers necessários para Django funcionar corretamente
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts (ajuste conforme necessário)
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# ============================================================================
# INSTRUÇÕES DE INSTALAÇÃO
# ============================================================================
#
# 1. Copie este arquivo para /etc/nginx/sites-available/akkaui
#
# 2. AJUSTE os seguintes valores:
#    - server_name: seu domínio
#    - alias /home/user/AkkaUi/media/: caminho do seu MEDIA_ROOT
#    - alias /home/user/AkkaUi/staticfiles/: caminho do seu STATIC_ROOT
#    - proxy_pass: porta onde Django/Gunicorn está rodando
#
# 3. Crie link simbólico:
#    sudo ln -s /etc/nginx/sites-available/akkaui /etc/nginx/sites-enabled/
#
# 4. Teste a configuração:
#    sudo nginx -t
#
# 5. Recarregue o Nginx:
#    sudo systemctl reload nginx
#
# 6. Configure Django (.env ou environment):
#    PROD=True
#    (USE_NGINX é automaticamente True quando PROD=True)
#
# ============================================================================
# VERIFICAÇÃO DE FUNCIONAMENTO
# ============================================================================
#
# Para verificar se X-Accel-Redirect está funcionando:
#
# 1. Acesse uma thumbnail no navegador (autenticado)
#
# 2. Verifique os logs do Django - deve aparecer:
#    "X-Accel-Redirect enviado: /internal_media/private/thumbnails/xxx.png"
#
# 3. Verifique os headers da resposta (F12 > Network):
#    - Status: 200 OK
#    - Não deve ter header X-Accel-Redirect (Nginx processa internamente)
#    - Content-Type: image/png (ou tipo correto)
#
# 4. Se receber 404:
#    - Verifique se o caminho alias está correto
#    - Verifique se o arquivo existe em MEDIA_ROOT
#    - Verifique os logs do Nginx
#
# 5. Se receber 403:
#    - Verifique permissões do diretório media/
#    - Nginx precisa ter permissão de leitura
#
# ============================================================================
