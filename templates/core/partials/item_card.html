{% load akka_filters %}
{% comment %}
Partial: Card reutiliz√°vel para exibir SvgFile (vari√°vel: item)
Usa Alpine.js para modal de preview e HTMX para carregar SVG via API
Seguran√ßa: usa item.get_sanitized_content que remove <script> e event handlers
{% endcomment %}

<div class="card" id="svg-card-{{ item.pk }}" x-data="{ showModal: false, imgError: false, svgHtml: '', svgLoading: false }">
  {# Preview do SVG #}
  <div class="svg-thumb">
    {% if item.thumbnail %}
      {# Op√ß√£o 1: Thumbnail existe - usar imagem #}
      <img 
        src="{{ item.thumbnail.url }}" 
        alt="Preview de {{ item.title_name|default:item.filename }}"
        loading="lazy"
        x-show="!imgError"
        @error="imgError = true"
      >
      <div class="svg-thumb-placeholder" x-show="imgError" style="display:none;">
        Sem pr√©via<br>dispon√≠vel
      </div>
    {% elif item.content %}
      {# Op√ß√£o 2: Sem thumbnail mas tem content - preview inline via data-URI #}
      {# Usa data-URI para evitar execu√ß√£o de scripts #}
      <img 
        src="data:image/svg+xml;base64,{{ item.get_sanitized_content|base64_encode }}"
        alt="Preview de {{ item.title_name|default:item.filename }}"
        loading="lazy"
        x-show="!imgError"
        @error="imgError = true"
      >
      <div class="svg-thumb-placeholder" x-show="imgError" style="display:none;">
        Erro ao carregar<br>pr√©via
      </div>
    {% else %}
      {# Op√ß√£o 3: Sem thumbnail e sem content - placeholder #}
      <div class="svg-thumb-placeholder">
        Sem pr√©via<br>dispon√≠vel
      </div>
    {% endif %}
  </div>

  {# Card Content - Novo Layout baseado no Figma #}
  <div style="padding: 1rem; display: flex; flex-direction: column; flex: 1;">
    {# Title #}
    <h3 class="card-title" title="{{ item.title_name|default:item.filename }}" style="margin: 0 0 0.25rem 0; font-size: 1rem;">
      {{ item.title_name|default:item.filename|default:"SVG sem nome" }}
    </h3>
    
    {# Description #}
    {% if item.description %}
      <p class="card-description" title="{{ item.description }}" style="margin: 0 0 auto 0; font-size: 0.8rem; color: var(--text-muted);">
        {{ item.description }}
      </p>
    {% else %}
      <p class="card-description text-muted" style="margin: 0 0 auto 0; font-size: 0.8rem;">
        Isto √© a descri√ß√£o
      </p>
    {% endif %}

    {# Price display and Status #}
    <div style="margin-top: 1rem;">
      {% if item.purchased_by_user or purchased or vip_access %}
        {# Badge de comprado ou acesso VIP #}
        {% if vip_access %}
          <div style="display: flex; align-items: center; justify-content: center; padding: 0.5rem; background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
            üëë Acesso VIP
          </div>
        {% else %}
          <div style="display: flex; align-items: center; justify-content: center; padding: 0.5rem; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
            ‚úÖ Comprado
          </div>
        {% endif %}
      {% elif item.price and item.price > 0 %}
        <div style="text-align: center; padding: 0.5rem 0;">
          <span style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">R$ {{ item.price }}</span>
        </div>
      {% else %}
        <div style="text-align: center; padding: 0.5rem; background: rgba(123, 255, 176, 0.1); border-radius: 8px;">
          <span style="font-size: 0.9rem; color: #7bffb0; font-weight: 600;">‚úì Gratuito</span>
        </div>
      {% endif %}
    </div>
  </div>

  {# A√ß√µes - Novo Layout baseado no Figma #}
  <div class="card-actions" style="padding: 0 1rem 1rem; gap: 0.75rem; display: flex;">
    {# Bot√£o Visualizar #}
    <button 
      @click="showModal = true" 
      class="btn btn-outline"
      type="button"
      aria-label="Visualizar {{ item.title_name|default:item.filename }}"
      style="flex: 1; padding: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.875rem;"
    >
      <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
      <span>Visualizar</span>
    </button>
    
    {% if item.purchased_by_user or purchased or vip_access %}
      {# Bot√£o Copiar - para SVGs j√° comprados ou com acesso VIP #}
      <button
        onclick="
          const btn = this;
          const originalText = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<i data-lucide=\'loader\' style=\'width: 16px; height: 16px; animation: spin 1s linear infinite;\'></i> Copiando...';
          
          function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              return navigator.clipboard.writeText(text);
            }
            
            return new Promise((resolve, reject) => {
              const textarea = document.createElement('textarea');
              textarea.value = text;
              textarea.style.position = 'fixed';
              textarea.style.left = '-999999px';
              textarea.style.top = '-999999px';
              document.body.appendChild(textarea);
              textarea.focus();
              textarea.select();
              
              try {
                const successful = document.execCommand('copy');
                document.body.removeChild(textarea);
                if (successful) {
                  resolve();
                } else {
                  reject(new Error('execCommand falhou'));
                }
              } catch (err) {
                document.body.removeChild(textarea);
                reject(err);
              }
            });
          }
          
          fetch('{% url 'core:copy_svg' %}?id={{ item.pk }}', {
            method: 'GET',
            headers: { 'Accept': 'application/json' }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Erro HTTP: ' + response.status);
            }
            return response.json();
          })
          .then(data => {
            if (data.svg_text) {
              return copyToClipboard(data.svg_text);
            } else {
              throw new Error('SVG n√£o encontrado na resposta');
            }
          })
          .then(() => {
            btn.innerHTML = '<i data-lucide=\'check\' style=\'width: 16px; height: 16px;\'></i> Copiado!';
            lucide.createIcons();
            setTimeout(() => {
              btn.disabled = false;
              btn.innerHTML = originalText;
              lucide.createIcons();
            }, 2000);
          })
          .catch(error => {
            console.error('Erro ao copiar:', error);
            if (typeof showToast === 'function') {
              showToast('Erro ao copiar SVG: ' + error.message, 'error');
            }
            btn.disabled = false;
            btn.innerHTML = originalText;
            lucide.createIcons();
          });
        "
        class="btn btn-primary"
        type="button"
        aria-label="Copiar SVG {{ item.title_name|default:item.filename }}"
        title="{% if vip_access %}Acesso VIP{% else %}Voc√™ j√° comprou este SVG{% endif %}"
        style="flex: 1; padding: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.875rem;"
      >
        <i data-lucide="copy" style="width: 16px; height: 16px;"></i>
        <span>Copiar</span>
      </button>
    {% elif item.price and item.price > 0 %}
      {# Bot√£o Adicionar ao Carrinho - para SVGs pagos #}
      <button
        onclick="addToCart('{{ item.pk }}', '{{ item.title_name|escapejs }}', {{ item.price }}, 'svg')"
        class="btn btn-primary"
        type="button"
        aria-label="Adicionar {{ item.title_name|default:item.filename }} ao carrinho"
        style="flex: 1; padding: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.875rem;"
      >
        <i data-lucide="shopping-cart" style="width: 16px; height: 16px;"></i>
        <span>Adicionar</span>
      </button>
      </button>
    {% else %}
      {# Bot√£o Copiar - para SVGs gratuitos #}
      <button
        onclick="
          const btn = this;
          const originalText = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<i data-lucide=\'loader\' style=\'width: 16px; height: 16px; animation: spin 1s linear infinite;\'></i> Copiando...';
          
          function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              return navigator.clipboard.writeText(text);
            }
            
            return new Promise((resolve, reject) => {
              const textarea = document.createElement('textarea');
              textarea.value = text;
              textarea.style.position = 'fixed';
              textarea.style.left = '-999999px';
              textarea.style.top = '-999999px';
              document.body.appendChild(textarea);
              textarea.focus();
              textarea.select();
              
              try {
                const successful = document.execCommand('copy');
                document.body.removeChild(textarea);
                if (successful) {
                  resolve();
                } else {
                  reject(new Error('execCommand falhou'));
                }
              } catch (err) {
                document.body.removeChild(textarea);
                reject(err);
              }
            });
          }
          
          fetch('{% url 'core:copy_svg' %}?id={{ item.pk }}', {
            method: 'GET',
            headers: { 'Accept': 'application/json' }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Erro HTTP: ' + response.status);
            }
            return response.json();
          })
          .then(data => {
            if (data.svg_text) {
              return copyToClipboard(data.svg_text);
            } else {
              throw new Error('SVG n√£o encontrado na resposta');
            }
          })
          .then(() => {
            btn.innerHTML = '<i data-lucide=\'check\' style=\'width: 16px; height: 16px;\'></i> Copiado!';
            lucide.createIcons();
            setTimeout(() => {
              btn.disabled = false;
              btn.innerHTML = originalText;
              lucide.createIcons();
            }, 2000);
          })
          .catch(error => {
            console.error('Erro ao copiar:', error);
            if (typeof showToast === 'function') {
              showToast('Erro ao copiar SVG: ' + error.message, 'error');
            }
            btn.disabled = false;
            btn.innerHTML = originalText;
            lucide.createIcons();
          });
        "
        class="btn btn-outline"
        type="button"
        aria-label="Copiar SVG {{ item.title_name|default:item.filename }}"
        style="flex: 1; padding: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.875rem;"
      >
        <i data-lucide="copy" style="width: 16px; height: 16px;"></i>
        <span>Copiar</span>
      </button>
    {% endif %}
  </div>

  {# Modal de Preview - Alpine.js #}
  <template x-teleport="body">
    <div 
      x-show="showModal" 
      x-cloak
      class="modal-backdrop"
      @click.self="showModal = false"
      @keydown.escape.window="showModal = false"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title-{{ item.pk }}"
      style="display: none;"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
    >
      <div class="modal">
        <div class="modal-header">
          <h3 id="modal-title-{{ item.pk }}">
            {{ item.title_name|default:item.filename|default:"Preview SVG" }}
          </h3>
          <button 
            @click="showModal = false" 
            class="modal-close"
            type="button"
            aria-label="Fechar modal"
          >
            √ó
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-preview" data-copy-url="{% url 'core:copy_svg' %}?id={{ item.pk }}">
            <!-- Lazy-load do SVG via Ajax/endpoint para evitar inje√ß√£o direta de markup no DOM -->
            <div x-show="svgLoading" class="text-muted">Carregando...</div>
            <div x-html="svgHtml" x-show="!svgLoading"></div>
            <script type="application/javascript">
              // Alpine effect: quando o modal abrir, buscar o SVG sanitizado uma √∫nica vez
              (function(){
                document.addEventListener('alpine:init', () => {
                  // nada aqui ‚Äî usamos x-effect inline no template abaixo
                })
              })();
            </script>
            <div x-effect="if (showModal && !svgHtml && !svgLoading) { svgLoading = true; var url = $el.closest('[data-copy-url]') ? $el.closest('[data-copy-url]').dataset.copyUrl : null; if (!url) { svgHtml = '<p class=\\'text-muted\\'>URL n√£o dispon√≠vel</p>'; svgLoading = false; } else { fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } }).then(r => { if (!r.ok) throw r; return r.json() }).then(data => { svgHtml = data.svg_text || '<p class=\\'text-muted\\'>Conte√∫do SVG n√£o dispon√≠vel</p>'; svgLoading = false }).catch(e => { svgHtml = '<p class=\\'text-muted\\'>Erro ao carregar SVG</p>'; svgLoading = false }) } }"></div>
          </div>
          {% if item.description %}
            <p class="mt-4 text-muted">{{ item.description }}</p>
          {% endif %}
        </div>
      </div>
    </div>
  </template>
</div>
