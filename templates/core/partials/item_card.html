{% load akka_filters %}
{% comment %}
Partial: Card reutilizável para exibir SvgFile (variável: item)
Usa Alpine.js para modal de preview e HTMX para carregar SVG via API
Segurança: usa item.get_sanitized_content que remove <script> e event handlers
{% endcomment %}

<div class="card" id="svg-card-{{ item.pk }}" x-data="{ showModal: false, imgError: false, svgHtml: '', svgLoading: false }">
  {# Preview do SVG #}
  <div class="card-image">
    {% if item.thumbnail %}
      {# Opção 1: Thumbnail existe - usar imagem #}
      <img 
        src="{{ item.thumbnail.url }}" 
        alt="Preview de {{ item.title_name|default:item.filename }}"
        loading="lazy"
        x-show="!imgError"
        @error="imgError = true"
      >
      <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-gray-500); font-size: 0.875rem; text-align: center;" x-show="imgError">
        Sem prévia<br>disponível
      </div>
    {% elif item.content %}
      {# Opção 2: Sem thumbnail mas tem content - preview inline via data-URI #}
      <img 
        src="data:image/svg+xml;base64,{{ item.get_sanitized_content|base64_encode }}"
        alt="Preview de {{ item.title_name|default:item.filename }}"
        loading="lazy"
        x-show="!imgError"
        @error="imgError = true"
      >
      <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-gray-500); font-size: 0.875rem; text-align: center;" x-show="imgError">
        Erro ao carregar<br>prévia
      </div>
    {% else %}
      {# Opção 3: Sem thumbnail e sem content - placeholder #}
      <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-gray-500); font-size: 0.875rem; text-align: center;">
        Sem prévia<br>disponível
      </div>
    {% endif %}
  </div>

  {# Conteúdo do card #}
  <div class="card-content">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
      <h3 style="color: var(--text-white); font-size: 1rem; font-weight: 600; margin: 0; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ item.title_name|default:item.filename }}">
        {{ item.title_name|default:item.filename|default:"SVG sem nome" }}
      </h3>
      
      {# Badge de comprado ou acesso VIP #}
      {% if vip_access %}
        <span class="badge badge-primary" style="font-size: 0.75rem; padding: 0.125rem 0.5rem;">
          👑 VIP
        </span>
      {% elif item.purchased_by_user or purchased %}
        <span class="badge badge-primary" style="font-size: 0.75rem; padding: 0.125rem 0.5rem; background-color: #4CAF50; border-color: #4CAF50;">
          ✓
        </span>
      {% endif %}
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
      <p style="color: var(--text-gray-400); font-size: 0.875rem; margin: 0;">by AkkaUi</p>
      
      {# Price or Free badge #}
      {% if item.price and item.price > 0 %}
        <span style="color: var(--text-white); font-weight: 600; font-size: 0.875rem;">R$ {{ item.price }}</span>
      {% else %}
        <span class="badge badge-primary" style="font-size: 0.75rem;">Free</span>
      {% endif %}
    </div>
    
    {# Ações #}
    <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
      {# Botão Visualizar #}
      <button 
        @click="showModal = true" 
        class="btn btn-secondary"
        type="button"
        style="flex: 1; padding: 0.5rem; font-size: 0.875rem; height: auto;"
        aria-label="Visualizar {{ item.title_name|default:item.filename }}"
      >
        👁️ Ver
      </button>
      
      {% if item.purchased_by_user or purchased or vip_access %}
        {# Botão Copiar - para SVGs já comprados ou com acesso VIP #}
        <button
          onclick="
            const btn = this;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '...';
            
            function copyToClipboard(text) {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
              }
              
              return new Promise((resolve, reject) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-999999px';
                textarea.style.top = '-999999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                
                try {
                  const successful = document.execCommand('copy');
                  document.body.removeChild(textarea);
                  if (successful) {
                    resolve();
                  } else {
                    reject(new Error('execCommand falhou'));
                  }
                } catch (err) {
                  document.body.removeChild(textarea);
                  reject(err);
                }
              });
            }
            
            fetch('{% url 'core:copy_svg' %}?id={{ item.pk }}', {
              method: 'GET',
              headers: { 'Accept': 'application/json' }
            })
            .then(response => {
              if (!response.ok) throw new Error('Erro HTTP: ' + response.status);
              return response.json();
            })
            .then(data => {
              if (data.svg_text) {
                return copyToClipboard(data.svg_text);
              } else {
                throw new Error('SVG não encontrado');
              }
            })
            .then(() => {
              btn.textContent = '✓';
              if (typeof showNotification === 'function') {
                showNotification('SVG copiado com sucesso!', 'success');
              }
              setTimeout(() => {
                btn.disabled = false;
                btn.textContent = originalText;
              }, 2000);
            })
            .catch(error => {
              console.error('Erro ao copiar:', error);
              if (typeof showNotification === 'function') {
                showNotification('Erro ao copiar SVG: ' + error.message, 'error');
              } else {
                alert('Erro ao copiar SVG: ' + error.message);
              }
              btn.disabled = false;
              btn.textContent = originalText;
            });
          "
          class="btn btn-primary"
          type="button"
          style="flex: 1; padding: 0.5rem; font-size: 0.875rem; height: auto;"
          aria-label="Copiar SVG {{ item.title_name|default:item.filename }}"
        >
          {% if vip_access %}👑 Copiar{% else %}📋 Copiar{% endif %}
        </button>
      {% elif item.price and item.price > 0 %}
        {# Botão Adicionar ao Carrinho - para SVGs pagos #}
        <button
          onclick="addToCart({{ item.pk }}, '{{ item.title_name|escapejs }}', {{ item.price }})"
          class="btn btn-primary"
          type="button"
          style="flex: 1; padding: 0.5rem; font-size: 0.875rem; height: auto;"
          aria-label="Adicionar {{ item.title_name|default:item.filename }} ao carrinho"
        >
          🛒 +
        </button>
      {% else %}
        {# Botão Copiar - para SVGs gratuitos #}
        <button
          onclick="
            const btn = this;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '...';
            
            function copyToClipboard(text) {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
              }
              
              return new Promise((resolve, reject) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-999999px';
                textarea.style.top = '-999999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                
                try {
                  const successful = document.execCommand('copy');
                  document.body.removeChild(textarea);
                  if (successful) {
                    resolve();
                  } else {
                    reject(new Error('execCommand falhou'));
                  }
                } catch (err) {
                  document.body.removeChild(textarea);
                  reject(err);
                }
              });
            }
            
            fetch('{% url 'core:copy_svg' %}?id={{ item.pk }}', {
              method: 'GET',
              headers: { 'Accept': 'application/json' }
            })
            .then(response => {
              if (!response.ok) throw new Error('Erro HTTP: ' + response.status);
              return response.json();
            })
            .then(data => {
              if (data.svg_text) {
                return copyToClipboard(data.svg_text);
              } else {
                throw new Error('SVG não encontrado');
              }
            })
            .then(() => {
              btn.textContent = '✓';
              if (typeof showNotification === 'function') {
                showNotification('SVG copiado com sucesso!', 'success');
              }
              setTimeout(() => {
                btn.disabled = false;
                btn.textContent = originalText;
              }, 2000);
            })
            .catch(error => {
              console.error('Erro ao copiar:', error);
              if (typeof showNotification === 'function') {
                showNotification('Erro ao copiar SVG: ' + error.message, 'error');
              } else {
                alert('Erro ao copiar SVG: ' + error.message);
              }
              btn.disabled = false;
              btn.textContent = originalText;
            });
          "
          class="btn btn-primary"
          type="button"
          style="flex: 1; padding: 0.5rem; font-size: 0.875rem; height: auto;"
          aria-label="Copiar SVG {{ item.title_name|default:item.filename }}"
        >
          📋 Copiar
        </button>
      {% endif %}
    </div>
  </div>

  {# Modal de Preview - Alpine.js #}
  <template x-teleport="body">
    <div 
      x-show="showModal" 
      x-cloak
      class="modal-backdrop"
      @click.self="showModal = false"
      @keydown.escape.window="showModal = false"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title-{{ item.pk }}"
      style="display: none;"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
    >
      <div class="modal">
        <div class="modal-header">
          <h3 id="modal-title-{{ item.pk }}">
            {{ item.title_name|default:item.filename|default:"Preview SVG" }}
          </h3>
          <button 
            @click="showModal = false" 
            class="modal-close"
            type="button"
            aria-label="Fechar modal"
          >
            ×
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-preview" data-copy-url="{% url 'core:copy_svg' %}?id={{ item.pk }}">
            <div x-show="svgLoading" class="text-muted">Carregando...</div>
            <div x-html="svgHtml" x-show="!svgLoading"></div>
            <div x-effect="if (showModal && !svgHtml && !svgLoading) { svgLoading = true; var url = $el.closest('[data-copy-url]') ? $el.closest('[data-copy-url]').dataset.copyUrl : null; if (!url) { svgHtml = '<p class=\\'text-muted\\'>URL não disponível</p>'; svgLoading = false; } else { fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } }).then(r => { if (!r.ok) throw r; return r.json() }).then(data => { svgHtml = data.svg_text || '<p class=\\'text-muted\\'>Conteúdo SVG não disponível</p>'; svgLoading = false }).catch(e => { svgHtml = '<p class=\\'text-muted\\'>Erro ao carregar SVG</p>'; svgLoading = false }) } }"></div>
          </div>
          {% if item.description %}
            <p class="mt-4 text-muted" style="margin-top: 1rem; color: var(--text-gray-400);">{{ item.description }}</p>
          {% endif %}
        </div>
      </div>
    </div>
  </template>
</div>
