{% extends 'core/base.html' %}

{% block title %}In√≠cio ‚Äî AkkaUi{% endblock %}

{% block content %}
  <article class="page">
    <header class="page-header">
      <h1>Bem-vindo ao AkkaUi</h1>
      <p class="lead">Seu cat√°logo completo de recursos de design UI modernos e responsivos com tema escuro.</p>
    </header>

    <div class="page-body">
      <section id="svg-tools" style="margin-bottom:2rem">

        <h3>SVGS salvos recentemente</h3>
                {% if svgfiles %}
                  <ul id="svg-list" style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:.5rem">
                    {% for item in svgfiles %}
                      <li data-id="{{ item.id }}" style="display:flex; justify-content:space-between; align-items:center; padding:.75rem 1rem; border:1px solid #2a2a2a; border-radius:8px">
                        <div style="display:flex; gap:1rem; align-items:center;">
                          <div class="svg-thumb-wrap" aria-hidden="true">
                            {% if item.thumbnail %}
                              <img class="svg-thumb" src="{{ item.thumbnail.url }}" alt="Thumbnail {{ item.title_name }}" loading="lazy" decoding="async"
                                  onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<div class=\'svg-thumb-placeholder\'>Sem imagem<br/>Pr√©via</div>');" />
                            {% elif item.content %}
                              <div class="svg-thumb svg-thumb-inline" aria-hidden="true" title="Pr√©-visualiza√ß√£o do SVG">
                                {{ item.get_sanitized_content|safe }}
                              </div>
                            {% else %}
                              <div class="svg-thumb-placeholder">Sem imagem<br/>Pr√©via</div>
                            {% endif %}
                          </div>
                          <div>
                            <strong>{{ item.title_name|default:"SVG" }}</strong>
                            <span class="muted" style="margin-left:.5rem">{{ item.uploaded_at }}</span>
                          </div>
                        </div>
                        <div style="display:flex; gap:.5rem; align-items:center">
                          <button class="btn btn-copy" data-id="{{ item.id }}">Copiar</button>
                        </div>
                      </li>
                    {% endfor %}
                  </ul>
        {% else %}
          <p class="muted">Nenhum SVG salvo ainda. Salve o primeiro usando o formul√°rio acima.</p>
        {% endif %}

        <template id="svg-list-item-template">
          <li style="display:flex; justify-content:space-between; align-items:center; padding:.75rem 1rem; border:1px solid #2a2a2a; border-radius:8px">
            <div>
              <strong class="name"></strong>
              <span class="muted ts" style="margin-left:.5rem"></span>
            </div>
            <div style="display:flex; gap:.5rem; align-items:center">
              <button class="btn btn-copy">Copiar</button>
            </div>
          </li>
        </template>

        <script>
          (function () {
            // Vers√£o m√≠nima: fun√ß√µes compartilhadas usadas em outros templates
            const copyUrl = "{% url 'core:copy_svg' %}"; // usado para obter svg sanitizado do backend

            const $list = document.getElementById('svg-list');
            const $copyEditor = document.getElementById('btn-copy-editor');
            const $ta = document.getElementById('svg-textarea');

            // utilit√°rio seguro para copiar texto (fallback)
            async function safeCopy(text) {
              if (!text) return;
              try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                  return await navigator.clipboard.writeText(text);
                }
              } catch (e) {
                // continua para fallback
              }
              return new Promise((resolve, reject) => {
                try {
                  const ta = document.createElement('textarea');
                  ta.value = text;
                  ta.setAttribute('readonly', '');
                  ta.style.position = 'absolute';
                  ta.style.left = '-9999px';
                  document.body.appendChild(ta);
                  ta.select();
                  const ok = document.execCommand && document.execCommand('copy');
                  document.body.removeChild(ta);
                  if (ok) resolve(); else reject(new Error('Fallback copy falhou'));
                } catch (err) {
                  reject(err);
                }
              });
            }

            async function copyFromDb(id) {
              try {
                const url = copyUrl + '?id=' + encodeURIComponent(id);
                const res = await fetch(url, { credentials: 'same-origin' });
                const ct = res.headers.get('content-type') || '';
                let data;
                if (ct.includes('application/json')) data = await res.json(); else data = { __raw_text: await res.text() };
                if (!res.ok) throw new Error((data && (data.error || data.__raw_text)) || res.statusText);
                const text = data.svg_text || data.__raw_text || '';
                await safeCopy(text);
                return true;
              } catch (err) {
                console.error(err);
                alert('N√£o foi poss√≠vel copiar do banco: ' + err.message);
                return false;
              }
            }

            // Delegated click handler para bot√µes .btn-copy dentro da lista
            document.addEventListener('click', (ev) => {
              const btn = ev.target.closest('.btn-copy');
              if (!btn) return;
              const id = btn.getAttribute('data-id') || btn.closest('li')?.dataset?.id;
              if (!id) return;
              btn.disabled = true;
              const old = btn.textContent;
              btn.textContent = 'Copiando...';
              copyFromDb(id).then(() => {
                btn.textContent = 'Copiado!';
                setTimeout(() => {
                  btn.disabled = false;
                  btn.textContent = old;
                }, 900);
              }).catch(() => {
                btn.disabled = false;
                btn.textContent = old;
              });
            });

            // Bot√£o que copia o conte√∫do do editor (se presente)
            if ($copyEditor && $ta) {
              $copyEditor.addEventListener('click', async () => {
                const text = ($ta.value || '').trim();
                if (!text) { alert('Cole um SVG no editor para copiar.'); return; }
                try {
                  await safeCopy(text);
                } catch (e) {
                  alert('Falha ao copiar do editor: ' + e.message);
                }
              });
            }
          })();
        </script>
      </section>

      <section id="getting-started">
        <h2>Come√ßando</h2>
        <p>Explore nossa cole√ß√£o de componentes, patterns e recursos de design. Navegue pelas categorias, veja exemplos e encontre inspira√ß√£o para seus projetos.</p>
      </section>

      <section id="features">
        <h2>Recursos</h2>
        <ul>
          <li>üé® Tema escuro moderno com paleta de cores personaliz√°vel</li>
          <li>üì± Design totalmente responsivo</li>
          <li>‚ö° Performance otimizada</li>
          <li>üîç Pesquisa r√°pida e intuitiva</li>
          <li>üéØ Interface limpa e profissional</li>
        </ul>
      </section>

      <section id="about">
        <h2>Sobre o AkkaUi</h2>
        <p>AkkaUi √© uma plataforma moderna inspirada em uiwiki.co, focada em apresenta√ß√£o de conte√∫do e leitura com tema escuro elegante. Utilizamos as cores #7460F3 (primary), #e7e7e7 (text), #7b7b7b (muted) e #0c0c0c (background) para criar uma experi√™ncia visual √∫nica.</p>
      </section>
    </div>

    <footer class="page-footer">
      <a class="btn" href="{% url 'core:explore' %}">Explorar Componentes</a>
    </footer>
  </article>
{% endblock %}
